{"changed":true,"filter":false,"title":"chat-server.py","tooltip":"/chat/chat-server.py","value":"import streamlit as st\nimport json\nimport websocket\nimport threading\nimport time\nfrom PIL import Image\nimport os\n\nst.title(\"ğŸ’¬ AI SERVICE\")\n\n# WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜\ndef on_message(ws, message):\n    detection_results = json.loads(message)\n    st.session_state['detection_results'] = detection_results\n    st.experimental_rerun()\n\n# WebSocket ì„¤ì •\nws_url = \"wss://your-websocket-api.execute-api.region.amazonaws.com/Prod\"\nws = websocket.WebSocketApp(ws_url, on_message=on_message)\n\ndef run_websocket():\n    ws.run_forever()\n\n# WebSocket ìŠ¤ë ˆë“œ ì‹œì‘\nthreading.Thread(target=run_websocket).start()\n\n# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”\nif \"stage\" not in st.session_state:\n    st.session_state.stage = 0\nif \"messages\" not in st.session_state:\n    st.session_state.messages = [\n        {\"role\": \"assistant\", \"content\": \"ì•ˆë…•í•˜ì„¸ìš”.<br>ê°€ë°©ì„ ëˆ•í˜€ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.\"}\n    ]\nif \"uploaded_image\" not in st.session_state:\n    st.session_state.uploaded_image = None\nif \"show_image\" not in st.session_state:\n    st.session_state.show_image = False\n\n# ë©”ì‹œì§€ í‘œì‹œ\nfor msg in st.session_state.messages:\n    st.chat_message(msg[\"role\"]).markdown(msg[\"content\"], unsafe_allow_html=True)\n\n# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •\nuploaded_file = './BAGGAGE_20240307_093706_140005_SUPERVISOR_A_ud.jpg'\n\n# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— í‘œì‹œ\nif st.session_state.stage == 0:\n    if uploaded_file and os.path.exists(uploaded_file):\n        st.session_state.uploaded_image = uploaded_file\n\n    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})\n    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")\n    with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):\n        time.sleep(5)\n    st.session_state.stage = 1\n    st.rerun()\n\nelif st.session_state.stage == 1:\n    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"})\n    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\")\n    st.session_state.stage = 2\n    st.rerun()\n\nelif st.session_state.stage == 2:\n    detection_results = st.session_state.get('detection_results', None)\n    if detection_results:\n        def get_position_text(positions):\n            position_texts = []\n            if positions[0] > 0:\n                position_texts.append(f\"ì™¼ìª½ ìƒë‹¨ì— {positions[0]}ê°œ\")\n            if positions[1] > 0:\n                position_texts.append(f\"ì˜¤ë¥¸ìª½ ìƒë‹¨ì— {positions[1]}ê°œ\")\n            if positions[2] > 0:\n                position_texts.append(f\"ì™¼ìª½ í•˜ë‹¨ì— {positions[2]}ê°œ\")\n            if positions[3] > 0:\n                position_texts.append(f\"ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— {positions[3]}ê°œ\")\n            return \", \".join(position_texts)\n\n        def generate_detection_message(detection_results):\n            total_objects = sum([obj[\"amount\"] for obj in detection_results[\"objects\"]])\n            detection_message = f\"ì´ {total_objects}ê°œì˜ ë¬¼í’ˆì´ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"\n            for obj in detection_results[\"objects\"]:\n                detection_message += f\"<br>{obj['type']}ê°€ {obj['amount']}ê°œ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"\n                position_text = get_position_text(obj[\"position\"])\n                detection_message += f\"<br>{obj['type']}ëŠ” {position_text}ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.\\n\"\n            return detection_message\n        \n        detection_message = generate_detection_message(detection_results)\n        st.session_state.messages.append({\"role\": \"assistant\", \"content\": detection_message})\n        st.chat_message(\"assistant\").write(detection_message)\n        st.session_state.show_image = True\n        st.session_state.stage = 3\n        st.rerun()\n\nelif st.session_state.stage == 3:\n    if st.session_state.show_image:\n        if os.path.exists(st.session_state.uploaded_image):\n            st.image(st.session_state.uploaded_image, caption='Detected Objects', use_column_width=True)\n        else:\n            st.error(f\"Error: The file at {st.session_state.uploaded_image} does not exist.\")\n\n    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})\n    st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")\n    st.session_state.stage = 4\n    st.rerun()\n\nelif st.session_state.stage == 4:\n    if st.button('Retry Scanning'):\n        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Retry Scanning\"})\n        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})\n        st.chat_message(\"assistant\").write(\"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")\n        with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):\n            time.sleep(5)\n        st.session_state.stage = 1\n        st.experimental_rerun()\n    if st.button('Complete'):\n        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Complete\"})\n        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})\n        st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")\n\ndef main():\n    pass\n\nif __name__ == '__main__':\n    main()\n","undoManager":{"mark":-2,"position":2,"stack":[[{"start":{"row":0,"column":0},"end":{"row":148,"column":0},"action":"insert","lines":["import streamlit as st","import time","import json","import websocket","import threading","from PIL import Image","import os","","st.title(\"ğŸ’¬ AI SERVICE\")","","# Function to fetch detection results from DynamoDB","def fetch_detection_results(index):","    dynamodb = boto3.client('dynamodb')","    response = dynamodb.get_item(","        TableName='xmen-detection-results',","        Key={","            'index': {'S': index}","        }","    )","    if 'Item' in response:","        item = response['Item']","        detection_results = {","            'index': item['index']['S'],","            'UserID': item['UserID']['S'],","            's3': item['s3']['S'],","            'objects': json.loads(item['objects']['S'])","        }","        return detection_results","    else:","        return None","","# Function to get position text","def get_position_text(positions):","    position_texts = []","    if positions[0] > 0:","        position_texts.append(f\"ì™¼ìª½ ìƒë‹¨ì— {positions[0]}ê°œ\")","    if positions[1] > 0:","        position_texts.append(f\"ì˜¤ë¥¸ìª½ ìƒë‹¨ì— {positions[1]}ê°œ\")","    if positions[2] > 0:","        position_texts.append(f\"ì™¼ìª½ í•˜ë‹¨ì— {positions[2]}ê°œ\")","    if positions[3] > 0:","        position_texts.append(f\"ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— {positions[3]}ê°œ\")","    return \", \".join(position_texts)","","# Function to generate detection message","def generate_detection_message(detection_results):","    total_objects = sum([obj[\"amount\"] for obj in detection_results[\"objects\"]])","    detection_message = f\"ì´ {total_objects}ê°œì˜ ë¬¼í’ˆì´ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","    for obj in detection_results[\"objects\"]:","        detection_message += f\"<br>{obj['type']}ê°€ {obj['amount']}ê°œ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","        position_text = get_position_text(obj[\"position\"])","        detection_message += f\"<br>{obj['type']}ëŠ” {position_text}ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.\\n\"","    return detection_message","","# Function to handle incoming WebSocket messages","def on_message(ws, message):","    detection_results = json.loads(message)","    st.session_state['detection_results'] = detection_results","    st.experimental_rerun()","","# Initialize WebSocket","ws_url = \"wss://your-websocket-api.execute-api.region.amazonaws.com/Prod\"","ws = websocket.WebSocketApp(ws_url, on_message=on_message)","","def run_websocket():","    ws.run_forever()","","# Start WebSocket in a new thread","threading.Thread(target=run_websocket).start()","","# Initialize session state","if \"stage\" not in st.session_state:","    st.session_state.stage = 0","if \"messages\" not in st.session_state:","    st.session_state.messages = [","        {\"role\": \"assistant\", \"content\": \"ì•ˆë…•í•˜ì„¸ìš”.<br>ê°€ë°©ì„ ëˆ•í˜€ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.\"}","    ]","if \"uploaded_image\" not in st.session_state:","    st.session_state.uploaded_image = None","if \"show_image\" not in st.session_state:","    st.session_state.show_image = False","","# ë©”ì‹œì§€ í‘œì‹œ","for msg in st.session_state.messages:","    st.chat_message(msg[\"role\"]).markdown(msg[\"content\"], unsafe_allow_html=True)","","# ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •","uploaded_file = './BAGGAGE_20240307_093706_140005_SUPERVISOR_A_ud.jpg'","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— í‘œì‹œ","if st.session_state.stage == 0:","    if uploaded_file and os.path.exists(uploaded_file):","        st.session_state.uploaded_image = uploaded_file","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","    with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","        time.sleep(5)","    st.session_state.stage = 1","    st.rerun()","","elif st.session_state.stage == 1:","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\")","    st.session_state.stage = 2","    st.rerun()","","elif st.session_state.stage == 2:","    detection_results = st.session_state.get('detection_results', None)","    if detection_results:","        detection_message = generate_detection_message(detection_results)","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": detection_message})","        st.chat_message(\"assistant\").write(detection_message)","        st.session_state.show_image = True","        st.session_state.stage = 3","        st.rerun()","","elif st.session_state.stage == 3:","    if st.session_state.show_image:","        if os.path.exists(st.session_state.uploaded_image):","            st.image(st.session_state.uploaded_image, caption='Detected Objects', use_column_width=True)","        else:","            st.error(f\"Error: The file at {st.session_state.uploaded_image} does not exist.\")","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","    st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","    st.session_state.stage = 4","    st.rerun()","","elif st.session_state.stage == 4:","    if st.button('Retry Scanning'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Retry Scanning\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","        st.chat_message(\"assistant\").write(\"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","        with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","            time.sleep(5)","        st.session_state.stage = 1","        st.experimental_rerun()","    if st.button('Complete'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Complete\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","        st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","","def main():","    pass","","if __name__ == '__main__':","    main()",""],"id":15}],[{"start":{"row":0,"column":0},"end":{"row":148,"column":0},"action":"remove","lines":["import streamlit as st","import time","import json","import websocket","import threading","from PIL import Image","import os","","st.title(\"ğŸ’¬ AI SERVICE\")","","# Function to fetch detection results from DynamoDB","def fetch_detection_results(index):","    dynamodb = boto3.client('dynamodb')","    response = dynamodb.get_item(","        TableName='xmen-detection-results',","        Key={","            'index': {'S': index}","        }","    )","    if 'Item' in response:","        item = response['Item']","        detection_results = {","            'index': item['index']['S'],","            'UserID': item['UserID']['S'],","            's3': item['s3']['S'],","            'objects': json.loads(item['objects']['S'])","        }","        return detection_results","    else:","        return None","","# Function to get position text","def get_position_text(positions):","    position_texts = []","    if positions[0] > 0:","        position_texts.append(f\"ì™¼ìª½ ìƒë‹¨ì— {positions[0]}ê°œ\")","    if positions[1] > 0:","        position_texts.append(f\"ì˜¤ë¥¸ìª½ ìƒë‹¨ì— {positions[1]}ê°œ\")","    if positions[2] > 0:","        position_texts.append(f\"ì™¼ìª½ í•˜ë‹¨ì— {positions[2]}ê°œ\")","    if positions[3] > 0:","        position_texts.append(f\"ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— {positions[3]}ê°œ\")","    return \", \".join(position_texts)","","# Function to generate detection message","def generate_detection_message(detection_results):","    total_objects = sum([obj[\"amount\"] for obj in detection_results[\"objects\"]])","    detection_message = f\"ì´ {total_objects}ê°œì˜ ë¬¼í’ˆì´ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","    for obj in detection_results[\"objects\"]:","        detection_message += f\"<br>{obj['type']}ê°€ {obj['amount']}ê°œ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","        position_text = get_position_text(obj[\"position\"])","        detection_message += f\"<br>{obj['type']}ëŠ” {position_text}ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.\\n\"","    return detection_message","","# Function to handle incoming WebSocket messages","def on_message(ws, message):","    detection_results = json.loads(message)","    st.session_state['detection_results'] = detection_results","    st.experimental_rerun()","","# Initialize WebSocket","ws_url = \"wss://your-websocket-api.execute-api.region.amazonaws.com/Prod\"","ws = websocket.WebSocketApp(ws_url, on_message=on_message)","","def run_websocket():","    ws.run_forever()","","# Start WebSocket in a new thread","threading.Thread(target=run_websocket).start()","","# Initialize session state","if \"stage\" not in st.session_state:","    st.session_state.stage = 0","if \"messages\" not in st.session_state:","    st.session_state.messages = [","        {\"role\": \"assistant\", \"content\": \"ì•ˆë…•í•˜ì„¸ìš”.<br>ê°€ë°©ì„ ëˆ•í˜€ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.\"}","    ]","if \"uploaded_image\" not in st.session_state:","    st.session_state.uploaded_image = None","if \"show_image\" not in st.session_state:","    st.session_state.show_image = False","","# ë©”ì‹œì§€ í‘œì‹œ","for msg in st.session_state.messages:","    st.chat_message(msg[\"role\"]).markdown(msg[\"content\"], unsafe_allow_html=True)","","# ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •","uploaded_file = './BAGGAGE_20240307_093706_140005_SUPERVISOR_A_ud.jpg'","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— í‘œì‹œ","if st.session_state.stage == 0:","    if uploaded_file and os.path.exists(uploaded_file):","        st.session_state.uploaded_image = uploaded_file","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","    with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","        time.sleep(5)","    st.session_state.stage = 1","    st.rerun()","","elif st.session_state.stage == 1:","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\")","    st.session_state.stage = 2","    st.rerun()","","elif st.session_state.stage == 2:","    detection_results = st.session_state.get('detection_results', None)","    if detection_results:","        detection_message = generate_detection_message(detection_results)","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": detection_message})","        st.chat_message(\"assistant\").write(detection_message)","        st.session_state.show_image = True","        st.session_state.stage = 3","        st.rerun()","","elif st.session_state.stage == 3:","    if st.session_state.show_image:","        if os.path.exists(st.session_state.uploaded_image):","            st.image(st.session_state.uploaded_image, caption='Detected Objects', use_column_width=True)","        else:","            st.error(f\"Error: The file at {st.session_state.uploaded_image} does not exist.\")","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","    st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","    st.session_state.stage = 4","    st.rerun()","","elif st.session_state.stage == 4:","    if st.button('Retry Scanning'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Retry Scanning\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","        st.chat_message(\"assistant\").write(\"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","        with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","            time.sleep(5)","        st.session_state.stage = 1","        st.experimental_rerun()","    if st.button('Complete'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Complete\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","        st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","","def main():","    pass","","if __name__ == '__main__':","    main()",""],"id":16,"ignore":true},{"start":{"row":0,"column":0},"end":{"row":125,"column":0},"action":"insert","lines":["import streamlit as st","import json","import websocket","import threading","import time","from PIL import Image","import os","","st.title(\"ğŸ’¬ AI SERVICE\")","","# WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜","def on_message(ws, message):  # [ìˆ˜ì •] WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜","    detection_results = json.loads(message)","    st.session_state['detection_results'] = detection_results","    st.experimental_rerun()","","# WebSocket ì„¤ì •","ws_url = \"wss://your-websocket-api.execute-api.region.amazonaws.com/Prod\"","ws = websocket.WebSocketApp(ws_url, on_message=on_message)  # [ìˆ˜ì •] WebSocket ì„¤ì •","","def run_websocket():  # [ìˆ˜ì •] WebSocket ìŠ¤ë ˆë“œ ì‹¤í–‰ í•¨ìˆ˜","    ws.run_forever()","","# WebSocket ìŠ¤ë ˆë“œ ì‹œì‘","threading.Thread(target=run_websocket).start()  # [ìˆ˜ì •] WebSocket ìŠ¤ë ˆë“œ ì‹œì‘","","# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”","if \"stage\" not in st.session_state:","    st.session_state.stage = 0","if \"messages\" not in st.session_state:","    st.session_state.messages = [","        {\"role\": \"assistant\", \"content\": \"ì•ˆë…•í•˜ì„¸ìš”.<br>ê°€ë°©ì„ ëˆ•í˜€ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.\"}","    ]","if \"uploaded_image\" not in st.session_state:","    st.session_state.uploaded_image = None","if \"show_image\" not in st.session_state:","    st.session_state.show_image = False","","# ë©”ì‹œì§€ í‘œì‹œ","for msg in st.session_state.messages:","    st.chat_message(msg[\"role\"]).markdown(msg[\"content\"], unsafe_allow_html=True)","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •","uploaded_file = './BAGGAGE_20240307_093706_140005_SUPERVISOR_A_ud.jpg'","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— í‘œì‹œ","if st.session_state.stage == 0:","    if uploaded_file and os.path.exists(uploaded_file):","        st.session_state.uploaded_image = uploaded_file","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","    with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","        time.sleep(5)","    st.session_state.stage = 1","    st.rerun()","","elif st.session_state.stage == 1:","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\")","    st.session_state.stage = 2","    st.rerun()","","elif st.session_state.stage == 2:","    detection_results = st.session_state.get('detection_results', None)","    if detection_results:","        def get_position_text(positions):","            position_texts = []","            if positions[0] > 0:","                position_texts.append(f\"ì™¼ìª½ ìƒë‹¨ì— {positions[0]}ê°œ\")","            if positions[1] > 0:","                position_texts.append(f\"ì˜¤ë¥¸ìª½ ìƒë‹¨ì— {positions[1]}ê°œ\")","            if positions[2] > 0:","                position_texts.append(f\"ì™¼ìª½ í•˜ë‹¨ì— {positions[2]}ê°œ\")","            if positions[3] > 0:","                position_texts.append(f\"ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— {positions[3]}ê°œ\")","            return \", \".join(position_texts)","","        def generate_detection_message(detection_results):","            total_objects = sum([obj[\"amount\"] for obj in detection_results[\"objects\"]])","            detection_message = f\"ì´ {total_objects}ê°œì˜ ë¬¼í’ˆì´ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","            for obj in detection_results[\"objects\"]:","                detection_message += f\"<br>{obj['type']}ê°€ {obj['amount']}ê°œ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","                position_text = get_position_text(obj[\"position\"])","                detection_message += f\"<br>{obj['type']}ëŠ” {position_text}ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.\\n\"","            return detection_message","        ","        detection_message = generate_detection_message(detection_results)","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": detection_message})","        st.chat_message(\"assistant\").write(detection_message)","        st.session_state.show_image = True","        st.session_state.stage = 3","        st.rerun()","","elif st.session_state.stage == 3:","    if st.session_state.show_image:","        if os.path.exists(st.session_state.uploaded_image):","            st.image(st.session_state.uploaded_image, caption='Detected Objects', use_column_width=True)","        else:","            st.error(f\"Error: The file at {st.session_state.uploaded_image} does not exist.\")","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","    st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","    st.session_state.stage = 4","    st.rerun()","","elif st.session_state.stage == 4:","    if st.button('Retry Scanning'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Retry Scanning\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","        st.chat_message(\"assistant\").write(\"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","        with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","            time.sleep(5)","        st.session_state.stage = 1","        st.experimental_rerun()","    if st.button('Complete'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Complete\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","        st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","","def main():","    pass","","if __name__ == '__main__':","    main()",""]}],[{"start":{"row":0,"column":0},"end":{"row":125,"column":0},"action":"remove","lines":["import streamlit as st","import json","import websocket","import threading","import time","from PIL import Image","import os","","st.title(\"ğŸ’¬ AI SERVICE\")","","# WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜","def on_message(ws, message):  # [ìˆ˜ì •] WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜","    detection_results = json.loads(message)","    st.session_state['detection_results'] = detection_results","    st.experimental_rerun()","","# WebSocket ì„¤ì •","ws_url = \"wss://your-websocket-api.execute-api.region.amazonaws.com/Prod\"","ws = websocket.WebSocketApp(ws_url, on_message=on_message)  # [ìˆ˜ì •] WebSocket ì„¤ì •","","def run_websocket():  # [ìˆ˜ì •] WebSocket ìŠ¤ë ˆë“œ ì‹¤í–‰ í•¨ìˆ˜","    ws.run_forever()","","# WebSocket ìŠ¤ë ˆë“œ ì‹œì‘","threading.Thread(target=run_websocket).start()  # [ìˆ˜ì •] WebSocket ìŠ¤ë ˆë“œ ì‹œì‘","","# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”","if \"stage\" not in st.session_state:","    st.session_state.stage = 0","if \"messages\" not in st.session_state:","    st.session_state.messages = [","        {\"role\": \"assistant\", \"content\": \"ì•ˆë…•í•˜ì„¸ìš”.<br>ê°€ë°©ì„ ëˆ•í˜€ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.\"}","    ]","if \"uploaded_image\" not in st.session_state:","    st.session_state.uploaded_image = None","if \"show_image\" not in st.session_state:","    st.session_state.show_image = False","","# ë©”ì‹œì§€ í‘œì‹œ","for msg in st.session_state.messages:","    st.chat_message(msg[\"role\"]).markdown(msg[\"content\"], unsafe_allow_html=True)","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •","uploaded_file = './BAGGAGE_20240307_093706_140005_SUPERVISOR_A_ud.jpg'","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— í‘œì‹œ","if st.session_state.stage == 0:","    if uploaded_file and os.path.exists(uploaded_file):","        st.session_state.uploaded_image = uploaded_file","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","    with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","        time.sleep(5)","    st.session_state.stage = 1","    st.rerun()","","elif st.session_state.stage == 1:","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\")","    st.session_state.stage = 2","    st.rerun()","","elif st.session_state.stage == 2:","    detection_results = st.session_state.get('detection_results', None)","    if detection_results:","        def get_position_text(positions):","            position_texts = []","            if positions[0] > 0:","                position_texts.append(f\"ì™¼ìª½ ìƒë‹¨ì— {positions[0]}ê°œ\")","            if positions[1] > 0:","                position_texts.append(f\"ì˜¤ë¥¸ìª½ ìƒë‹¨ì— {positions[1]}ê°œ\")","            if positions[2] > 0:","                position_texts.append(f\"ì™¼ìª½ í•˜ë‹¨ì— {positions[2]}ê°œ\")","            if positions[3] > 0:","                position_texts.append(f\"ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— {positions[3]}ê°œ\")","            return \", \".join(position_texts)","","        def generate_detection_message(detection_results):","            total_objects = sum([obj[\"amount\"] for obj in detection_results[\"objects\"]])","            detection_message = f\"ì´ {total_objects}ê°œì˜ ë¬¼í’ˆì´ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","            for obj in detection_results[\"objects\"]:","                detection_message += f\"<br>{obj['type']}ê°€ {obj['amount']}ê°œ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","                position_text = get_position_text(obj[\"position\"])","                detection_message += f\"<br>{obj['type']}ëŠ” {position_text}ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.\\n\"","            return detection_message","        ","        detection_message = generate_detection_message(detection_results)","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": detection_message})","        st.chat_message(\"assistant\").write(detection_message)","        st.session_state.show_image = True","        st.session_state.stage = 3","        st.rerun()","","elif st.session_state.stage == 3:","    if st.session_state.show_image:","        if os.path.exists(st.session_state.uploaded_image):","            st.image(st.session_state.uploaded_image, caption='Detected Objects', use_column_width=True)","        else:","            st.error(f\"Error: The file at {st.session_state.uploaded_image} does not exist.\")","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","    st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","    st.session_state.stage = 4","    st.rerun()","","elif st.session_state.stage == 4:","    if st.button('Retry Scanning'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Retry Scanning\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","        st.chat_message(\"assistant\").write(\"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","        with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","            time.sleep(5)","        st.session_state.stage = 1","        st.experimental_rerun()","    if st.button('Complete'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Complete\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","        st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","","def main():","    pass","","if __name__ == '__main__':","    main()",""],"id":17,"ignore":true},{"start":{"row":0,"column":0},"end":{"row":125,"column":0},"action":"insert","lines":["import streamlit as st","import json","import websocket","import threading","import time","from PIL import Image","import os","","st.title(\"ğŸ’¬ AI SERVICE\")","","# WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜","def on_message(ws, message):","    detection_results = json.loads(message)","    st.session_state['detection_results'] = detection_results","    st.experimental_rerun()","","# WebSocket ì„¤ì •","ws_url = \"wss://your-websocket-api.execute-api.region.amazonaws.com/Prod\"","ws = websocket.WebSocketApp(ws_url, on_message=on_message)","","def run_websocket():","    ws.run_forever()","","# WebSocket ìŠ¤ë ˆë“œ ì‹œì‘","threading.Thread(target=run_websocket).start()","","# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”","if \"stage\" not in st.session_state:","    st.session_state.stage = 0","if \"messages\" not in st.session_state:","    st.session_state.messages = [","        {\"role\": \"assistant\", \"content\": \"ì•ˆë…•í•˜ì„¸ìš”.<br>ê°€ë°©ì„ ëˆ•í˜€ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.\"}","    ]","if \"uploaded_image\" not in st.session_state:","    st.session_state.uploaded_image = None","if \"show_image\" not in st.session_state:","    st.session_state.show_image = False","","# ë©”ì‹œì§€ í‘œì‹œ","for msg in st.session_state.messages:","    st.chat_message(msg[\"role\"]).markdown(msg[\"content\"], unsafe_allow_html=True)","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •","uploaded_file = './BAGGAGE_20240307_093706_140005_SUPERVISOR_A_ud.jpg'","","# ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ í™”ë©´ì— í‘œì‹œ","if st.session_state.stage == 0:","    if uploaded_file and os.path.exists(uploaded_file):","        st.session_state.uploaded_image = uploaded_file","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","    with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","        time.sleep(5)","    st.session_state.stage = 1","    st.rerun()","","elif st.session_state.stage == 1:","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"})","    st.chat_message(\"assistant\").write(\"ìŠ¤ìº”ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.\")","    st.session_state.stage = 2","    st.rerun()","","elif st.session_state.stage == 2:","    detection_results = st.session_state.get('detection_results', None)","    if detection_results:","        def get_position_text(positions):","            position_texts = []","            if positions[0] > 0:","                position_texts.append(f\"ì™¼ìª½ ìƒë‹¨ì— {positions[0]}ê°œ\")","            if positions[1] > 0:","                position_texts.append(f\"ì˜¤ë¥¸ìª½ ìƒë‹¨ì— {positions[1]}ê°œ\")","            if positions[2] > 0:","                position_texts.append(f\"ì™¼ìª½ í•˜ë‹¨ì— {positions[2]}ê°œ\")","            if positions[3] > 0:","                position_texts.append(f\"ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— {positions[3]}ê°œ\")","            return \", \".join(position_texts)","","        def generate_detection_message(detection_results):","            total_objects = sum([obj[\"amount\"] for obj in detection_results[\"objects\"]])","            detection_message = f\"ì´ {total_objects}ê°œì˜ ë¬¼í’ˆì´ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","            for obj in detection_results[\"objects\"]:","                detection_message += f\"<br>{obj['type']}ê°€ {obj['amount']}ê°œ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\"","                position_text = get_position_text(obj[\"position\"])","                detection_message += f\"<br>{obj['type']}ëŠ” {position_text}ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.\\n\"","            return detection_message","        ","        detection_message = generate_detection_message(detection_results)","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": detection_message})","        st.chat_message(\"assistant\").write(detection_message)","        st.session_state.show_image = True","        st.session_state.stage = 3","        st.rerun()","","elif st.session_state.stage == 3:","    if st.session_state.show_image:","        if os.path.exists(st.session_state.uploaded_image):","            st.image(st.session_state.uploaded_image, caption='Detected Objects', use_column_width=True)","        else:","            st.error(f\"Error: The file at {st.session_state.uploaded_image} does not exist.\")","","    st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","    st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","    st.session_state.stage = 4","    st.rerun()","","elif st.session_state.stage == 4:","    if st.button('Retry Scanning'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Retry Scanning\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\"})","        st.chat_message(\"assistant\").write(\"ë‹¤ì‹œ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...\")","        with st.spinner(\"ìŠ¤ìº” ì¤‘...\"):","            time.sleep(5)","        st.session_state.stage = 1","        st.experimental_rerun()","    if st.button('Complete'):","        st.session_state.messages.append({\"role\": \"user\", \"content\": \"Complete\"})","        st.session_state.messages.append({\"role\": \"assistant\", \"content\": \"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\"})","        st.chat_message(\"assistant\").write(\"í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.\")","","def main():","    pass","","if __name__ == '__main__':","    main()",""]}]]},"ace":{"folds":[],"scrolltop":1302.5999999999983,"scrollleft":0,"selection":{"start":{"row":11,"column":19},"end":{"row":11,"column":19},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":80,"state":"start","mode":"ace/mode/python"}},"timestamp":1716354162148}